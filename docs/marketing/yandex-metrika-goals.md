# Настройка целей Яндекс.Метрики

## Обзор

В проекте реализовано автоматическое отслеживание ключевых действий пользователей через JavaScript цели Яндекс.Метрики.

**ID счетчика:** 104326103

## Реализованные цели

### 1. Звонки (`phone_call`)
**Описание:** Отслеживает клики по всем ссылкам с телефонными номерами (tel:)

**Триггер:** Клик по любой ссылке `<a href="tel:...">` на сайте

**Параметры:**
- `phone` - номер телефона из href
- `element` - текст элемента, по которому кликнули

**Примеры элементов:**
- Кнопка в шапке: `+7 (920) 366-36-36`
- Кнопки CTA: "Вызвать ритуального агента 24/7"
- Все телефонные ссылки в футере и секции контактов

---

### 2. Открытие калькулятора (`calculator_open`)
**Описание:** Фиксирует момент открытия модального окна калькулятора стоимости

**Триггер:** Клик по кнопке "Перейти к расчету" в секции CalculatorSection

**Компонент:** `src/pages/HomePage/components/CalculatorSection/CalculatorSection.jsx`

**Код реализации:**
```javascript
const handleOpenQuiz = () => {
  trackGoal('calculator_open');
  openQuiz();
};
```

---

### 3. Успешная отправка формы калькулятора (`calculator_submit_success`)
**Описание:** Отслеживает успешную отправку заявки через калькулятор

**Триггер:** Успешная отправка формы с контактными данными (после прохождения всех шагов калькулятора)

**Параметры:**
- `burial_type` - выбранный вид захоронения (funeral/cremation)
- `product_type` - выбранный тип гроба/урны (economy/standard/premium)

**Компонент:** `src/components/QuizCalculator/QuizCalculator.jsx`

**Код реализации:**
```javascript
await sendToTelegram(finalData);

trackGoal('calculator_submit_success', {
  burial_type: finalData.step_1,
  product_type: finalData.step_2
});
```

---

### 4. Построение маршрута (`route_click`)
**Описание:** Фиксирует клики по кнопкам "Маршрут" для построения пути до офисов

**Триггер:** Клик по ссылке на Яндекс.Карты с текстом "Маршрут"

**Параметры:**
- `url` - полный URL ссылки на Яндекс.Карты

**Примеры элементов:**
- Кнопки "Маршрут" под адресами офисов в секции контактов
- Ссылки на карты в разделе "Наши офисы"

---

### 5. Переход на страницу услуг (`services_page_visit`)
**Описание:** Отслеживает переходы на любую страницу услуг

**Триггер:** Клик по любой ссылке, содержащей `/uslugi` в URL

**Параметры:**
- `url` - URL страницы услуги
- `service_name` - название услуги из текста ссылки

**Примеры:**
- Карточки услуг на главной странице
- Пункт меню "Услуги"
- Ссылки "Подробнее →" в карточках услуг

---

## Структура файлов

```
src/
├── utils/
│   └── yandexGoals.js          # Утилита для отслеживания целей
├── components/
│   ├── YandexMetrika/
│   │   └── YandexMetrika.jsx   # Компонент счетчика + инициализация целей
│   └── QuizCalculator/
│       └── QuizCalculator.jsx  # Отслеживание отправки формы
└── pages/
    └── HomePage/
        └── components/
            └── CalculatorSection/
                └── CalculatorSection.jsx  # Отслеживание открытия калькулятора
```

---

## Техническая реализация

### Файл: `src/utils/yandexGoals.js`

**Основная функция:**
```javascript
const reachGoal = (goalName, params = {}) => {
  if (typeof window !== 'undefined' && window.ym) {
    window.ym(104326103, 'reachGoal', goalName, params);
  }
};
```

**Инициализация отслеживания:**
```javascript
export const initYandexGoals = () => {
  // Настройка глобальных обработчиков событий для автоматического отслеживания
  document.addEventListener('click', (e) => {
    // Обработка кликов по телефонным ссылкам
    // Обработка кликов по ссылкам на маршруты
    // Обработка кликов по ссылкам на услуги
  });
};
```

**Экспортируемые функции:**
- `initYandexGoals()` - инициализация автоматического отслеживания
- `trackGoal(goalName, params)` - ручная отправка цели из компонентов

---

## Настройка целей в интерфейсе Яндекс.Метрики

### Шаг 1: Войдите в Яндекс.Метрику
1. Перейдите на https://metrika.yandex.ru/
2. Выберите счетчик **104326103**
3. Перейдите в раздел **"Настройка" → "Цели"**

### Шаг 2: Создайте JavaScript-цели

Для каждой цели нажмите **"Добавить цель"** и выберите тип **"JavaScript-событие"**:

#### Цель 1: Звонки
- **Название:** Звонок по телефону
- **Идентификатор:** `phone_call`
- **Описание:** Клик по ссылке с телефоном

#### Цель 2: Открытие калькулятора
- **Название:** Открытие калькулятора
- **Идентификатор:** `calculator_open`
- **Описание:** Клик по кнопке "Перейти к расчету"

#### Цель 3: Отправка формы калькулятора
- **Название:** Отправка формы калькулятора
- **Идентификатор:** `calculator_submit_success`
- **Описание:** Успешная отправка заявки через калькулятор

#### Цель 4: Построение маршрута
- **Название:** Построение маршрута
- **Идентификатор:** `route_click`
- **Описание:** Клик по кнопке "Маршрут" до офиса

#### Цель 5: Переход на страницу услуг
- **Название:** Просмотр услуги
- **Идентификатор:** `services_page_visit`
- **Описание:** Переход на любую страницу услуг

### Шаг 3: Сохраните цели

После добавления всех целей, нажмите **"Сохранить"**. Цели начнут собирать данные автоматически.

---

## Проверка работы целей

### В консоли браузера

После выполнения действия (например, клика по телефону) в консоли должно появиться сообщение:
```
[Яндекс.Метрика] Цель достигнута: phone_call {phone: "tel:79203663636", element: "+7 (920) 366-36-36"}
```

### В режиме отладки Яндекс.Метрики

1. Откройте сайт в браузере
2. Откройте консоль разработчика (F12)
3. Выполните целевое действие (например, кликните по телефону)
4. Проверьте вкладку Network → найдите запросы к `mc.yandex.ru`
5. В параметрах запроса должен быть `goal_id` с названием цели

### В интерфейсе Яндекс.Метрики

**Важно:** Данные по целям начнут отображаться через 15-30 минут после первого достижения.

1. Перейдите в **"Отчеты" → "Стандартные отчеты" → "Конверсии"**
2. Выберите период "Сегодня"
3. В списке целей должны появиться созданные цели с количеством достижений

---

## Использование в компонентах

### Импорт функции отслеживания
```javascript
import { trackGoal } from '@/utils/yandexGoals';
```

### Отправка цели при событии
```javascript
const handleClick = () => {
  // Выполняем действие
  doSomething();

  // Отправляем цель в метрику
  trackGoal('goal_name', {
    param1: 'value1',
    param2: 'value2'
  });
};
```

---

## Отладка

### Проверка инициализации
В консоли браузера после загрузки страницы должно появиться:
```
[Яндекс.Метрика] Отслеживание целей инициализировано
```

### Включение подробных логов
Все цели логируются в консоль при отправке. Для production-версии можно отключить логирование, закомментировав строку:
```javascript
console.log(`[Яндекс.Метрика] Цель достигнута: ${goalName}`, params);
```

---

## Аналитика и оптимизация

### Рекомендуемые отчеты для анализа

1. **Воронка конверсии:**
   - calculator_open → calculator_submit_success
   - Показывает % пользователей, завершивших расчет

2. **Источники целевых действий:**
   - Анализ, откуда приходят пользователи, совершающие звонки
   - Сегментация по устройствам (мобильные vs десктоп)

3. **Карта кликов:**
   - Визуализация кликов по телефонным номерам
   - Анализ популярности разных CTA

### Метрики для мониторинга

- **Коэффициент конверсии в звонок:** phone_call / visits
- **Процент завершения калькулятора:** calculator_submit_success / calculator_open
- **Интерес к услугам:** services_page_visit / visits
- **Использование навигации:** route_click / visits

---

## Troubleshooting

### Цели не отправляются

**Проблема:** В консоли нет сообщений о достижении целей

**Решение:**
1. Проверьте, что Яндекс.Метрика загрузилась: `window.ym !== undefined`
2. Проверьте, что инициализация целей выполнилась успешно
3. Убедитесь, что ID счетчика верный (104326103)

### Цели отправляются, но не отображаются в отчетах

**Проблема:** Консоль показывает отправку, но в метрике данных нет

**Решение:**
1. Подождите 15-30 минут (задержка обработки данных)
2. Убедитесь, что цели созданы в интерфейсе Яндекс.Метрики
3. Проверьте, что идентификаторы целей совпадают с кодом

### Дублирование целей

**Проблема:** Одна цель отправляется несколько раз при одном действии

**Решение:**
1. Проверьте, что `initYandexGoals()` вызывается только один раз
2. Используйте флаги для предотвращения повторной отправки
3. Убедитесь, что обработчики событий не дублируются

---

## Документация Яндекс.Метрики

- [Справка по JavaScript-целям](https://yandex.ru/support/metrica/general/goal-js-event.html)
- [Метод reachGoal](https://yandex.ru/support/metrica/objects/reachgoal.html)
- [Настройка целей](https://yandex.ru/support/metrica/general/goals.html)

---

## История изменений

- **2025-01-10:** Первоначальная настройка 5 целей для отслеживания ключевых действий
